<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Map Layer Editor</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="page-container">
        <div class="main-content">
            <h1>Map Layer Editor</h1>
            <form method="post" enctype="multipart/form-data">
                <div class="form-group">
                    <label for="pgm_file">PGM Map File:</label>
                    <input type="file" id="pgm_file" name="pgm_file" accept=".pgm" required>
                </div>
                <div class="form-group">
                    <label for="yaml_file">YAML Config File:</label>
                    <input type="file" id="yaml_file" name="yaml_file" accept=".yaml,.yml" required>
                </div>
                <div class="form-group">
                    <label for="csv_file">Original CSV Waypoints File:</label>
                    <input type="file" id="csv_file" name="csv_file" accept=".csv" required>
                </div>
                <button type="submit">Load Map and Waypoints</button>
            </form>

            {% if error %}
                <p class="error">{{ error }}</p>
            {% endif %}

            {% if map_image_base64 and map_metadata_json %}
                <div id="controls">
                    <div class="controls-group">
                        <button id="zoom-in" title="Zoom In"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/><path d="M10 9h-1v1h1v1h1v-1h1V9h-1V8h-1v1z"/></svg> Zoom In</button>
                        <button id="zoom-out" title="Zoom Out"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14zM7 9h5v1H7z"/></svg> Zoom Out</button>
                        <button id="reset-view" title="Reset View"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 5V1L7 6l5 5V7c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z"/></svg> Reset</button>
                    </div>
                    <div class="controls-group">
                        <button id="export-csv" title="Export New Waypoints as CSV"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg> Export CSV</button>
                    </div>
                </div>

                <div id="editor-container">
                    <img id="base-layer-img" src="data:image/png;base64,{{ map_image_base64 }}" alt="Base Map with Original Waypoints">
                    <canvas id="interactive-layer-canvas"></canvas>
                </div>
                
                <!-- Hidden div to pass metadata to JavaScript -->
                <div id="map-metadata" data-metadata='{{ map_metadata_json|safe }}' data-waypoints='{{ original_waypoints_json|safe }}'></div>
            {% endif %}
        </div>
        <div class="sidebar">
            <div class="instructions">
                <h2>Instructions</h2>
                <ul>
                    <li>The original path is shown in blue on the background image.</li>
                    <li>You can edit the magenta path on the interactive top layer.</li>
                    <li><strong>Pan:</strong> Click and drag the map background.</li>
                    <li><strong>Move Waypoint:</strong> Click and drag a waypoint to an empty area.</li>
                    <li><strong>Re-order Path:</strong> Drag a waypoint and drop it onto another waypoint.</li>
                    <li><strong>Add Waypoint:</strong> Double-click on an empty area of the map.</li>
                    <li><strong>Edit Waypoint:</strong> Double-click on an existing waypoint to edit its X, Y, and Theta values.</li>
                    <li><strong>Delete Waypoint:</strong> Right-click on a waypoint.</li>
                </ul>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/interactive_map.js') }}"></script>

    <!-- Waypoint Editor Modal -->
    <div id="waypoint-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h2 id="modal-title">Edit Waypoint</h2>
            <form id="waypoint-form">
                <div class="form-field">
                    <label for="waypoint-x">X Coordinate</label>
                    <input type="number" id="waypoint-x" step="any" required>
                </div>
                <div class="form-field">
                    <label for="waypoint-y">Y Coordinate</label>
                    <input type="number" id="waypoint-y" step="any" required>
                </div>
                <div class="form-field">
                    <label for="waypoint-theta">Theta (Angle)</label>
                    <input type="number" id="waypoint-theta" step="any" required>
                </div>
                <div class="modal-actions">
                    <button type="button" id="cancel-waypoint">Cancel</button>
                    <button type="submit" id="save-waypoint">Save</button>
                </div>
            </form>
        </div>
    </div>
</body>
</html>